// jshint ignore: start
+function($){

$.rawCitiesData = [

  {
    "name": "鲤城",
    "code":"350502",
    "sub": [
    {
      "name": "海滨街道",
      "code":"35050201"
    },
    {
      "name": "临江街道",
      "code":"35050202"
    },
    {
      "name": "鲤中街道",
      "code":"35050203"
    },
    {
      "name": "开元街道",
      "code":"35050204"
    },
    {
      "name": "浮桥街道",
      "code":"35050205"
    },
    {
      "name": "江南街道",
      "code":"35050206"
    },
    {
      "name": "金龙街道",
      "code":"35050207"
    },
    {
      "name": "常泰街道",
      "code":"35050208"
    },
    {
      "name": "清濛经济开发区",
      "code":"35050209"
    }]
  },
  {
    "name": "丰泽",
    "code":"350503",
    "sub": [
    {
      "name": "东湖街道",
      "code":"35050301"
    },
    {
      "name": "丰泽街道",
      "code":"35050302"
    },
    {
      "name": "泉秀街道",
      "code":"35050303"
    },
    {
      "name": "清源街道",
      "code":"35050304"
    },
    {
      "name": "华大街道",
      "code":"35050305"
    },
    {
      "name": "城东街道",
      "code":"35050306"
    },
    {
      "name": "东海街道",
      "code":"35050307"
    },
    {
      "name": "北峰街道",
      "code":"35050308"
    }]
  },
  {
    "name": "洛江",
      "code":"35050401",
    "sub": [
    {
      "name": "万安街道",
      "code":"35050401"
    },
    {
      "name": "双阳街道",
      "code":"35050402"
    },
    {
      "name": "罗溪镇",
      "code":"35050403"
    },
    {
      "name": "马甲镇",
      "code":"35050404"
    },
    {
      "name": "河市镇",
      "code":"35050405"
    },
    {
      "name": "虹山乡",
      "code":"35050406"
    }]
  },
  {
    "name": "泉港",
      "code":"35050501",
    "sub": [
    {
      "name": "山腰街道",
      "code":"35050501"
    },
    {
      "name": "南埔镇",
      "code":"35050502"
    },
    {
      "name": "界山镇",
      "code":"35050503"
    },
    {
      "name": "后龙镇",
      "code":"35050504"
    },
    {
      "name": "峰尾镇",
      "code":"35050505"
    },
    {
      "name": "前黄镇",
      "code":"35050506"
    },
    {
      "name": "涂岭镇",
      "code":"35050507"
    }]
  },
  {
    "name": "惠安",
            "code":"350521",
    "sub": [
    {
      "name": "螺城镇",
            "code":"35052101"
    },
    {
      "name": "螺阳镇",
            "code":"35052102"
    },
    {
      "name": "黄塘镇",
            "code":"35052103"
    },
    {
      "name": "紫山镇",
            "code":"35052104"
    },
    {
      "name": "洛阳镇",
            "code":"35052105"
    },
    {
      "name": "东园镇",
            "code":"35052106"
    },
    {
      "name": "张坂镇",
            "code":"35052107"
    },
    {
      "name": "崇武镇",
            "code":"35052108"
    },
    {
      "name": "山霞镇",
            "code":"35052109"
    },
    {
      "name": "涂寨镇",
            "code":"35052110"
    },
    {
      "name": "东岭镇",
            "code":"35052111"
    },
    {
      "name": "东桥镇",
            "code":"35052112"
    },
    {
      "name": "净峰镇",
            "code":"35052113"
    },
    {
      "name": "小岞镇",
            "code":"35052114"
    },
    {
      "name": "辋川镇",
            "code":"35052115"
    },
    {
      "name": "百崎回族乡",
            "code":"35052116"
    },
    {
      "name": "城南工业区",
            "code":"35052117"
    },
    {
      "name": "惠南工业区",
            "code":"35052118"
    }]
  },
  {
    "name": "安溪",
            "code":"350524",
    "sub": [
    {
      "name": "凤城镇",
            "code":"35052401"
    },
    {
      "name": "蓬莱镇",
            "code":"35052402"
    },
    {
      "name": "湖头镇",
            "code":"35052403"
    },
    {
      "name": "官桥镇",
            "code":"35052404"
    },
    {
      "name": "剑斗镇",
            "code":"35052405"
    },
    {
      "name": "城厢镇",
            "code":"35052406"
    },
    {
      "name": "金谷镇",
            "code":"35052407"
    },
    {
      "name": "龙门镇",
            "code":"35052408"
    },
    {
      "name": "虎邱镇",
            "code":"35052409"
    },
    {
      "name": "芦田镇",
            "code":"35052410"
    },
    {
      "name": "感德镇",
            "code":"35052411"
    },
    {
      "name": "魁斗镇",
            "code":"35052412"
    },
    {
      "name": "西坪镇",
            "code":"35052413"
    },
    {
      "name": "参内乡",
            "code":"35052414"
    },
    {
      "name": "白濑乡",
            "code":"35052415"
    },
    {
      "name": "湖上乡",
            "code":"35052416"
    },
    {
      "name": "尚卿乡",
            "code":"35052417"
    },
    {
      "name": "大坪乡",
            "code":"35052418"
    },
    {
      "name": "龙涓乡",
            "code":"35052419"
    },
    {
      "name": "长坑乡",
            "code":"35052420"
    },
    {
      "name": "蓝田乡",
            "code":"35052421"
    },
    {
      "name": "祥华乡",
            "code":"35052422"
    },
    {
      "name": "桃舟乡",
            "code":"35052423"
    },
    {
      "name": "福田乡",
            "code":"35052424"
    }]
  },
  {
    "name": "永春",
            "code":"350525",
    "sub": [
    {
      "name": "桃城镇",
            "code":"35052501"
    },
    {
      "name": "五里街镇",
            "code":"35052502"
    },
    {
      "name": "一都镇",
            "code":"35052503"
    },
    {
      "name": "下洋镇",
            "code":"35052504"
    },
    {
      "name": "蓬壶镇",
            "code":"35052505"
    },
    {
      "name": "达埔镇",
            "code":"35052506"
    },
    {
      "name": "吾峰镇",
            "code":"35052507"
    },
    {
      "name": "石鼓镇",
            "code":"35052508"
    },
    {
      "name": "岵山镇",
            "code":"35052509"
    },
    {
      "name": "东平镇",
            "code":"35052510"
    },
    {
      "name": "湖洋镇",
            "code":"35052511"
    },
    {
      "name": "坑仔口镇",
            "code":"35052512"
    },
    {
      "name": "玉斗镇",
            "code":"35052513"
    },
    {
      "name": "锦斗镇",
            "code":"35052514"
    },
    {
      "name": "东关镇",
            "code":"35052515"
    },
    {
      "name": "桂洋镇",
            "code":"35052516"
    },
    {
      "name": "苏坑镇",
            "code":"35052517"
    },
    {
      "name": "仙夹镇",
            "code":"35052518"
    },
    {
      "name": "横口乡",
            "code":"35052519"
    },
    {
      "name": "呈祥乡",
            "code":"35052520"
    },
    {
      "name": "介福乡",
            "code":"35052521"
    },
    {
      "name": "外山乡",
            "code":"35052522"
    }]
  },
  {
    "name": "德化",
            "code":"350526",
    "sub": [
    {
      "name": "浔中镇",
            "code":"35052601"
    },
    {
      "name": "龙浔镇",
            "code":"35052602"
    },
    {
      "name": "三班镇",
            "code":"35052603"
    },
    {
      "name": "龙门滩镇",
            "code":"35052604"
    },
    {
      "name": "雷峰镇",
            "code":"35052605"
    },
    {
      "name": "南埕镇",
            "code":"35052606"
    },
    {
      "name": "水口镇",
            "code":"35052607"
    },
    {
      "name": "赤水镇",
            "code":"35052601"
    },
    {
      "name": "上涌镇",
            "code":"35052608"
    },
    {
      "name": "葛坑镇",
            "code":"35052609"
    },
    {
      "name": "盖德镇",
            "code":"35052620"
    },
    {
      "name": "杨梅乡",
            "code":"35052621"
    },
    {
      "name": "汤头乡",
            "code":"35052622"
    },
    {
      "name": "桂阳乡",
            "code":"35052623"
    },
    {
      "name": "国宝乡",
            "code":"35052624"
    },
    {
      "name": "美湖镇",
            "code":"35052625"
    },
    {
      "name": "大铭乡",
            "code":"35052626"
    },
    {
      "name": "春美乡",
            "code":"35052627"
    }]
  },
  {
    "name": "石狮",
            "code":"350581",
    "sub": [
    {
      "name": "湖滨街道",
            "code":"35058101"
    },
    {
      "name": "凤里街道",
            "code":"35058102"
    },
    {
      "name": "灵秀镇",
            "code":"35058103"
    },
    {
      "name": "宝盖镇",
            "code":"35058104"
    },
    {
      "name": "蚶江镇",
            "code":"35058105"
    },
    {
      "name": "祥芝镇",
            "code":"35058106"
    },
    {
      "name": "鸿山镇",
            "code":"35058107"
    },
    {
      "name": "锦尚镇",
            "code":"35058108"
    },
    {
      "name": "永宁镇",
            "code":"35058109"
    }]
  },
  {
    "name": "晋江",
            "code":"350582",
    "sub": [
    {
      "name": "青阳街道",
            "code":"35058201"
    },
    {
      "name": "梅岭街道",
            "code":"35058202"
    },
    {
      "name": "西园街道",
            "code":"35058203"
    },
    {
      "name": "罗山街道",
            "code":"35058204"
    },
    {
      "name": "新塘街道",
            "code":"35058205"
    },
    {
      "name": "灵源街道",
            "code":"35058206"
    },
    {
      "name": "安海镇",
            "code":"35058207"
    },
    {
      "name": "磁灶镇",
            "code":"35058208"
    },
    {
      "name": "陈埭镇",
            "code":"35058209"
    },
    {
      "name": "东石镇",
            "code":"35058210"
    },
    {
      "name": "深沪镇",
            "code":"35058211"
    },
    {
      "name": "金井镇",
            "code":"35058212"
    },
    {
      "name": "池店镇",
            "code":"35058213"
    },
    {
      "name": "内坑镇",
            "code":"35058214"
    },
    {
      "name": "龙湖镇",
            "code":"35058215"
    },
    {
      "name": "永和镇",
            "code":"35058216"
    },
    {
      "name": "英林镇",
            "code":"35058217"
    },
    {
      "name": "紫帽镇",
            "code":"35058218"
    },
    {
      "name": "西滨镇",
            "code":"35058219"
    },
    {
      "name": "安平开发区",
            "code":"35058220"
    },
    {
      "name": "晋江市经济开发区",
            "code":"35058221"
    },
    {
      "name": "泉州出口加工区",
            "code":"35058222"
    }]
  },
  {
    "name": "南安",
            "code":"350583",
    "sub": [
    {
      "name": "溪美街道",
            "code":"35058301"
    },
    {
      "name": "柳城街道",
            "code":"35058302"
    },
    {
      "name": "美林街道",
            "code":"35058303"
    },
    {
      "name": "省新镇",
            "code":"35058304"
    },
    {
      "name": "仑苍镇",
            "code":"35058305"
    },
    {
      "name": "东田镇",
            "code":"35058306"
    },
    {
      "name": "英都镇",
            "code":"35058307"
    },
    {
      "name": "翔云镇",
            "code":"35058308"
    },
    {
      "name": "金淘镇",
            "code":"35058309"
    },
    {
      "name": "诗山镇",
            "code":"35058310"
    },
    {
      "name": "蓬华镇",
            "code":"35058311"
    },
    {
      "name": "码头镇",
            "code":"35058312"
    },
    {
      "name": "九都镇",
            "code":"35058313"
    },
    {
      "name": "乐峰镇",
            "code":"35058314"
    },
    {
      "name": "罗东镇",
            "code":"35058315"
    },
    {
      "name": "梅山镇",
            "code":"35058316"
    },
    {
      "name": "洪濑镇",
            "code":"35058317"
    },
    {
      "name": "洪梅镇",
            "code":"35058318"
    },
    {
      "name": "康美镇",
            "code":"35058319"
    },
    {
      "name": "丰州镇",
            "code":"35058320"
    },
    {
      "name": "霞美镇",
            "code":"35058321"
    },
    {
      "name": "官桥镇",
            "code":"35058322"
    },
    {
      "name": "水头镇",
            "code":"35058323"
    },
    {
      "name": "石井镇",
            "code":"35058324"
    },
    {
      "name": "眉山乡",
            "code":"35058325"
    },
    {
      "name": "向阳乡",
            "code":"35058326"
    },
    {
      "name": "雪峰管委会",
            "code":"35058327"
    }]
  }

];
}($);
// jshint ignore: end

/* global $:true */
/* jshint unused:false*/

+ function($) {
  "use strict";

  var defaults;
  var raw = $.rawCitiesData;

  var format = function(data) {
    var result = [];
    for(var i=0;i<data.length;i++) {
      var d = data[i];
      if(/^请选择|市辖区/.test(d.name)) continue;
      result.push(d);
    }
    if(result.length) return result;
    return [];
  };

  var sub = function(data) {
    if(!data.sub) return [{ name: '', code: data.code }];  // 有可能某些县级市没有区
    return format(data.sub);
  };

  var getCities = function(d) {
    for(var i=0;i< raw.length;i++) {
      if(raw[i].code === d || raw[i].name === d) return sub(raw[i]);
    }
    return [];
  };

  var getDistricts = function(p, c) {
    for(var i=0;i< raw.length;i++) {
      if(raw[i].code === p || raw[i].name === p) {
        for(var j=0;j< raw[i].sub.length;j++) {
          if(raw[i].sub[j].code === c || raw[i].sub[j].name === c) {
            return sub(raw[i].sub[j]);
          }
        }
      }
    }
  };

  var parseInitValue = function (val) {
    var p = raw[0], c, d;
    var tokens = val.split(' ');
    raw.map(function (t) {
      if (t.name === tokens[0]) p = t;
    });

    p.sub.map(function (t) {
      if (t.name === tokens[1]) c = t;
    })

    if (tokens[2]) {
      c.sub.map(function (t) {
        if (t.name === tokens[2]) d = t;
      })
    }

    if (d) return [p.code, c.code, d.code];
    return [p.code, c.code];
  }

  $.fn.cityPicker = function(params) {
    params = $.extend({}, defaults, params);
    return this.each(function() {
      var self = this;
      
      var provincesName = raw.map(function(d) {
        return d.name;
      });
      var provincesCode = raw.map(function(d) {
        return d.code;
      });
      var initCities = sub(raw[0]);
      var initCitiesName = initCities.map(function (c) {
        return c.name;
      });
      var initCitiesCode = initCities.map(function (c) {
        return c.code;
      });
      var initDistricts = sub(raw[0].sub[0]);

      var initDistrictsName = initDistricts.map(function (c) {
        return c.name;
      });
      var initDistrictsCode = initDistricts.map(function (c) {
        return c.code;
      });

      var currentProvince = provincesName[0];
      var currentCity = initCitiesName[0];
      var currentDistrict = initDistrictsName[0];

      var cols = [
          {
            displayValues: provincesName,
            values: provincesCode,
            cssClass: "col-province"
          },
          {
            displayValues: initCitiesName,
            values: initCitiesCode,
            cssClass: "col-city"
          }
        ];

        if(params.showDistrict) cols.push({
          values: initDistrictsCode,
          displayValues: initDistrictsName,
          cssClass: "col-district"
        });

      var config = {

        cssClass: "city-picker",
        rotateEffect: false,  //为了性能
        formatValue: function (p, values, displayValues) {
          return displayValues.join(' ');
        },
        onChange: function (picker, values, displayValues) {
          var newProvince = picker.cols[0].displayValue;
          var newCity;
          if(newProvince !== currentProvince) {
            var newCities = getCities(newProvince);
            newCity = newCities[0].name;
            var newDistricts = getDistricts(newProvince, newCity);
            picker.cols[1].replaceValues(newCities.map(function (c) {
              return c.code;
            }), newCities.map(function (c) {
              return c.name;
            }));
            if(params.showDistrict) picker.cols[2].replaceValues(newDistricts.map(function (d) {
              return d.code;
            }), newDistricts.map(function (d) {
              return d.name;
            }));
            currentProvince = newProvince;
            currentCity = newCity;
            picker.updateValue();
            return false; // 因为数据未更新完，所以这里不进行后序的值的处理
          } else {
            if(params.showDistrict) {
              newCity = picker.cols[1].displayValue;
              if(newCity !== currentCity) {
                var districts = getDistricts(newProvince, newCity);
                picker.cols[2].replaceValues(districts.map(function (d) {
                  return d.code;
                }), districts.map(function (d) {
                  return d.name;
                }));
                currentCity = newCity;
                picker.updateValue();
                return false; // 因为数据未更新完，所以这里不进行后序的值的处理
              }
            }
          }
          //如果最后一列是空的，那么取倒数第二列
          var len = (values[values.length-1] ? values.length - 1 : values.length - 2)
          $(self).attr('data-code', values[len]);
          $(self).attr('data-codes', values.join(','));
          if (params.onChange) {
            params.onChange.call(self, picker, values, displayValues);
          }
        },

        cols: cols
      };

      if(!this) return;
      var p = $.extend({}, params, config);
      //计算value
      var val = $(this).val();
      if (!val) val = '鲤城 海滨街道';
      currentProvince = val.split(" ")[0];
      currentCity = val.split(" ")[1];
      currentDistrict= val.split(" ")[2];
      if(val) {
        p.value = parseInitValue(val);
        if(p.value[0]) {
          var cities = getCities(p.value[0]);
          p.cols[1].values = cities.map(function (c) {
            return c.code;
          });
          p.cols[1].displayValues = cities.map(function (c) {
            return c.name;
          });
        }

        if(p.value[1]) {
          if (params.showDistrict) {
            var dis = getDistricts(p.value[0], p.value[1]);
            p.cols[2].values = dis.map(function (d) {
              return d.code;
            });
            p.cols[2].displayValues = dis.map(function (d) {
              return d.name;
            });
          }
        } else {
          if (params.showDistrict) {
            var dis = getDistricts(p.value[0], p.cols[1].values[0]);
            p.cols[2].values = dis.map(function (d) {
              return d.code;
            });
            p.cols[2].displayValues = dis.map(function (d) {
              return d.name;
            });
          }
        }
      }
      $(this).picker(p);
    });
  };

  defaults = $.fn.cityPicker.prototype.defaults = {
    showDistrict: true //是否显示地区选择
  };

}($);
