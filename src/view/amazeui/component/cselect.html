<!-- 字段组件 -->
<template id="cselect">
    <!--layerPage-->
    <!--需要用js赋值一下，没有绑定。不知道为啥-->
    <select v-model="value" ref="mySelect" style="width:100%;height:50px;" v-bind:disabled ="is_detail == 1"> 
        <option value="" >请选择</option> 
        <!--兼容列表为徽章的写法-->
        <option v-for="(tmpOption,k) in option" v-bind:value="k" v-if="tmpOption && tmpOption.label">
            {{tmpOption.label}}
        </option>
        <!--【正常的枚举】-->
        <option v-for="(tmpOption,k) in option" v-bind:value="k" v-if="tmpOption && !tmpOption.label">
            {{tmpOption}}
        </option>
    </select>
</template>

<script>
    //定义hblock组件
    Vue.component('cselect', {
        props: { value : String, option : Array ,is_detail : String, multiple : String, data_ajax : String},//multiple复选
        template: '#cselect',
        watch:{
            //主数据变化即触发
            value : {
                handler :function(newName, oldName) {
                    if(this.multiple){
                        if(typeof(newName)=='string'){
                            //按逗号分隔成数组
                            this.value = newName.split(',');
                        }
                        console.log('复选框赋值');
//                        $(this.$refs.mySelect).select2();
                        $(this.$refs.mySelect).val( this.value ).trigger("change"); //多选赋值
                    } else {
                        $(this.$refs.mySelect).val( this.value ).trigger("change"); //多选赋值
                    }
                    this.$emit('linkage');
                },
                // 代表在wacth里声明了firstName这个方法之后立即先去执行handler方法
                immediate: true
            },
        },
        methods: {
            doInit :function(){
                //重新渲染树状
                var that = this;
                var selectParam = {};
                if(that.multiple){
                    selectParam.multiple = true;
                } else if( !that.multiple && that.data_ajax * 1 > 0 ){
                    selectParam.placeholder = '请输入关键词搜索';
                    selectParam.minimumInputLength= 1;
                    //ajax接口数据：20210506
                    selectParam.ajax = {
                        url: "{:url('admin/SSystem/dynSearch')}?columnListId=" + that.data_ajax ,
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                search: params.term,
                            };
                        },
                        processResults: function (data) {
                            return {
                                results: data.data
                            };
                        }
                    };
                }
                that.$nextTick(function () {
                    $( that.$refs.mySelect ).select2(selectParam);
                    $(that.$refs.mySelect).on("select2:select",function(e){
                        if(that.multiple){
                            var targetOptions = e.target.options;
                            console.log(targetOptions);
                            var all = [];
                            for(var i=0;i<targetOptions.length;i++){
                                if(targetOptions[i].selected){
                                    all.push(targetOptions[i].value);
                                }
                            }
                            that.value = all;
                        } else {
                            that.value = e.target.value;
                        }
                        that.$emit('input', that.value );
                    })
                });                
            }
        },
        created :function(){
            this.doInit();
        },
        mounted : function(){

        },
    });
</script>
